// ... (Existing code from Task 1 & 2) ...

// --- New DOM Element Reference ---
const categoryFilter = document.getElementById('categoryFilter'); // NEW reference

// --- New Storage Key for Filter ---
const FILTER_KEY = 'lastSelectedCategory'; // Key for Local Storage filter persistence

// --- Filtering and Display Functions ---

/**
 * Extracts unique categories from the quotes array and populates the filter dropdown.
 */
function populateCategories() {
    // 1. Get unique categories
    const uniqueCategories = ['all']; // Start with 'all' option
    quotes.forEach(quote => {
        const category = quote.category.trim();
        if (category && !uniqueCategories.includes(category)) {
            uniqueCategories.push(category);
        }
    });

    // 2. Clear and populate the dropdown
    categoryFilter.innerHTML = ''; // Clear existing options
    uniqueCategories.sort().forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = (category === 'all') ? 'All Categories' : category;
        categoryFilter.appendChild(option);
    });

    // 3. Restore the last selected filter state (if saved)
    restoreFilter();
}

/**
 * Restores the last selected category from Local Storage and triggers filtering.
 */
function restoreFilter() {
    const lastFilter = localStorage.getItem(FILTER_KEY);
    if (lastFilter && lastFilter !== 'all') {
        // Find the option in the newly populated list and select it
        if (Array.from(categoryFilter.options).some(opt => opt.value === lastFilter)) {
            categoryFilter.value = lastFilter;
        }
    }
    // Now display the quotes based on the current filter selection
    displayFilteredQuotes(); 
}

/**
 * Filters the quotes array based on the dropdown selection, saves the filter, and updates the DOM.
 */
function filterQuotes() {
    const selectedCategory = categoryFilter.value;
    
    // 1. Save the new selection to Local Storage
    localStorage.setItem(FILTER_KEY, selectedCategory);

    // 2. Display the filtered quotes
    displayFilteredQuotes();
}

/**
 * Displays the list of quotes matching the current filter, or all quotes if 'all' is selected.
 */
function displayFilteredQuotes() {
    const selectedCategory = categoryFilter.value;
    
    // Determine the array of quotes to display
    const quotesToDisplay = (selectedCategory === 'all')
        ? quotes
        : quotes.filter(quote => quote.category === selectedCategory);

    // Clear the random quote display area
    quoteDisplay.innerHTML = ''; 

    // Create a container for the list (optional, but good practice for filtering views)
    const listContainer = document.createElement('ul');
    listContainer.style.listStyle = 'none';
    listContainer.style.textAlign = 'left';
    
    if (quotesToDisplay.length === 0) {
        quoteDisplay.innerHTML = `<p>No quotes found in the category: **${selectedCategory}**.</p>`;
        return;
    }

    quotesToDisplay.forEach(quote => {
        const listItem = document.createElement('li');
        listItem.innerHTML = `<strong>"${quote.text}"</strong> - <em>(${quote.category})</em>`;
        listContainer.appendChild(listItem);
    });

    // Replace the single quote display with the list of filtered quotes
    quoteDisplay.appendChild(listContainer);
}


// --- Updated Core Functions ---

/**
 * Handles the logic for adding a new quote from the form input.
 * MODIFIED to call populateCategories() to update the dropdown immediately.
 */
function addQuote() {
    // ... (Existing validation and quote object creation) ...
    const textInput = document.getElementById('newQuoteText');
    const categoryInput = document.getElementById('newQuoteCategory');

    const newText = textInput.value.trim();
    const newCategory = categoryInput.value.trim();

    if (newText === '' || newCategory === '') {
        alert('Please enter both a quote and a category.');
        return;
    }

    const newQuote = {
        text: newText,
        category: newCategory
    };
    quotes.push(newQuote);
    
    saveQuotes(); // Save to Local Storage
    
    // **NEW STEP: Update the category dropdown if a new category was added**
    populateCategories(); 

    alert(`Quote added successfully! Total quotes: ${quotes.length}`);
    textInput.value = '';
    categoryInput.value = '';
    
    // Show the updated list based on the current filter
    displayFilteredQuotes();
}

/**
 * The Show New Quote button now triggers filtering/listing instead of just random display.
 * NOTE: We can change the button's behavior to specifically show a random quote
 * among the *filtered* results if needed, but for simplicity here, we'll ensure
 * it shows the filtered list.
 * If you want the old random behavior, you can revert this, but typically in
 * filtered view, you see the list.
 */
newQuoteButton.addEventListener('click', () => {
    // Since the primary display now is a list, the button should refresh the list.
    // If 'all' is selected, this is equivalent to showing all content.
    displayFilteredQuotes();
});


// --- Initialization (MODIFIED ORDER) ---

// 1. Load quotes from Local Storage
loadQuotes();

// 2. Populate the filter dropdown and restore the last filter state
populateCategories();

// 3. The displayFilteredQuotes() called by populateCategories/restoreFilter handles initial display.

// 4. Create the dynamic form from Task 0/1
createAddQuoteForm();

// ... (Other existing event listeners for exportButton and importFile) ...
